# PR Check Workflow
# Validates pull requests before merge to main branch.
# Runs linting, tests, build, and CDK synth to verify template generation.

name: PR Check

on:
  pull_request:
    branches: [main]
  merge_group:
    branches: [main]

permissions:
  contents: read

jobs:
  validate:
    name: Validate
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          submodules: true  # Required for ISB submodule

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linting
        run: npm run lint

      - name: Run tests
        run: |
          export PATH="$(pwd)/node_modules/.bin:$PATH"
          npm run test:ci

      - name: Build
        run: npm run build

      - name: Verify CDK template generation
        run: |
          npx cdk synth --quiet \
            -c environment=test \
            -c hubAccountId=123456789012 \
            -c orgMgmtAccountId=098765432109 \
            -c accountTableName=isb-sandbox-accounts \
            -c sandboxOuId=ou-test-sandbox \
            -c availableOuId=ou-test-available \
            -c quarantineOuId=ou-test-quarantine \
            -c cleanupOuId=ou-test-cleanup \
            -c intermediateRoleArn=arn:aws:iam::123456789012:role/isb-hub-role \
            -c orgMgtRoleArn=arn:aws:iam::098765432109:role/isb-org-mgt-role
